

{% extends 'base.html' %}
{% load static %}
{% block title %}<title>Upcoming Blends</title>{% endblock %}
{% block scripts %}<link rel="stylesheet" type="text/css" href ="{% static 'core/issuesheets.css' %}">{% endblock %}

{% block content %}
    <div class='text-center'>
        <h1>Select Blends to Count</h1>
        <h5><em>Blends shown in order of appearance on production schedule</em></h5>
        <br/>
        <button id="create_list">Create Count List</button>
        <br/>
    </div>
    <div id="selection_table" class="table-responsive-sm">
        <br/>
        <table class="table text-left table-bordered">
            <thead class="thead-dark"style="position: sticky; top: 55px; z-index: 2 !important;">
                <tr>
                    <th scope="col" class='text-center'>Add to Count List</th>
                    <th scope="col" class='text-center'>Blend</th>
                    <th scope="col" class='text-center'>Description</th>
                    <th scope="col" class='text-center'>Start Time</th>
                    <th scope="col" class='text-center'>Exp. Qty</th>
                    <th scope="col" class='text-center'>Last Count</th>
                    <th scope="col" class='text-center'>Last Transaction</th>
                    <th scope="col" class='text-center'>Shortage</th>
                    <th scope="col" class='text-center'>Report</th>
                </tr>
            </thead>
            {% for item in upcoming_blends %}
                <tr>
                    <td id="cb" class='text-center'>
                        <input type="checkbox" name={{ item.blend_pn }}></input>
                    </td>
                    <td>{{ item.blend_pn }}</td>
                    <td>{{ item.blend_desc }}</td>
                    <td>{{ item.starttime|floatformat:2 }}</td>
                    <td>{{ item.expected_on_hand|floatformat:2 }}</td>
                    <td>{{ item.last_count|floatformat:0 }}: {{ item.last_count_date|date:"m-d-y" }}</td>
                    <td>{{ item.last_transaction_type }}: {{ item.last_transaction_date|date:"m-d-y" }}</td>
                    <td>
                        {% if item.short_hour == 0 %}
                            No
                        {% else %}
                            {{ item.short_hour|floatformat:2 }}
                        {% endif %}
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                Select
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                <li><a class="dropdown-item" href="/core/reports/Lot-Numbers/{{ item.blend_pn }}">Lot Numbers</a></li>
                                <li><a class="dropdown-item" href="/core/reports/All-Upcoming-Runs/{{ item.blend_pn }}">All Upcoming Runs</a></li>
                                <li><a class="dropdown-item" href="/core/reports/Transaction-History/{{ item.blend_pn }}">Transaction History</a></li>
                                <li><a class="dropdown-item" href="/core/reports/Count-History/{{ item.blend_pn }}">Count History</a></li>
                            </ul>
                        </div>
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
    <script>
        // https://stackoverflow.com/questions/1287592/get-checkbox-list-values-with-jquery
        $(document).ready(function() {
            $('#create_list').click(function() {
                let part_numbers = [];
                $('td input:checked').each(function() {
                    part_numbers.push($(this).attr("name"));
                });
                console.log(part_numbers)
                // https://stackoverflow.com/questions/4505871/good-way-to-serialize-a-list-javascript-ajax
                let encoded_list = btoa(JSON.stringify(part_numbers));
                console.log(encoded_list)
                base_url = window.location.href.split('core')[0];
                // https://stackoverflow.com/questions/503093/how-do-i-redirect-to-another-webpage
                window.location.replace(base_url + "core/countlist/add/"+encoded_list)
            });
        });
    </script>
{% endblock content %}