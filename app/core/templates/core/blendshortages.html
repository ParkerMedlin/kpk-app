{% extends 'base.html' %}
{% load static %}

{% block title %}<title>Blend Shortages</title>{% endblock %}

{% block scripts %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/css/blendShortages.css' %}">
{% endblock scripts %}
    

{% block content %}

    {% include 'core/modals/add-lotnum-modal.html' %}
    {% if foam_factor_is_populated %}
        <div class='text-center'>
            <h1>Blend Shortages</h1>
            <br/><br/> 
        </div>
        <table class="table text-left table-bordered table-hover">
            <thead class="thead-dark" style="position: sticky; top: 55px; z-index: 2 !important;">
                <tr>
                    <th scope="col" class="text-center">Blend</th>
                    <th scope="col" class="text-center">Description</th>
                    <th scope="col" class="text-center">Last Count</th>
                    <th scope="col" class="text-center">Last Txn</th>
                    <th scope="col" class="text-center">When Short</th>
                    <th scope="col" class="text-center">Line</th>
                    <th scope="col" class="text-center">Total Short</th>
                    {% if user.is_staff %}
                        <th scope="col">Lot Number</th>
                    {% endif %}
                    <th scope="col" class="text-center">Schedule Status</th>
                </tr>
            </thead>
            {% for item in blend_these_queryset %}
                <tr {% if item.item_code == "602037" or item.item_code == "602602" %}class="msrRow"{% endif %}{% if item.needs_count %}needsCount="needsCount"{% endif %}>
                    <td>
                        <span title="{{ item.ingredients_list }}">
                            <div class="dropdown">
                                <button class="btn dropdown-toggle blendinfo" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                    {% if item.component_item_code == "602037" or item.component_item_code == "602602" %}
                                        <img src="{% static 'core/media/shrk.png' %}" height="50" width="50"></img>
                                    {% else %}
                                        <i class="fa fa-info-circle"></i>
                                    {% endif %}
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                    <li><a class="dropdown-item" href="/core/reports/Lot-Numbers/{{ item.component_item_code }}">
                                        Lot Numbers
                                    </a></li>
                                    <li><a class="dropdown-item" href="/core/reports/Transaction-History/{{ item.component_item_code }}">
                                        Transaction History
                                    </a></li>
                                    <li><a class="dropdown-item" href="/core/reports/All-Upcoming-Runs/{{ item.component_item_code }}">
                                        Upcoming Runs
                                    </a></li>
                                    <li><a class="dropdown-item" href="/core/reports/Count-History/{{ item.component_item_code }}">
                                        Count History
                                    </a></li>
                                </ul>
                                {{ item.component_item_code }}
                            </div>
                        </span>
                    </td>
                    <td>{{ item.component_item_description }}</td>
                    <td>                            
                        <span title="{{ item.last_count_quantity|floatformat:0 }} gallons">{{ item.last_count_date }}</span>
                    </td>
                    <td>
                        {% if item.last_txn_code == "II" %}
                            <span title="{{ item.last_txn_code }} - Inventory Adjustment">{{ item.last_txn_date }}</span>
                        {% elif item.last_txn_code == "BI" %}
                            <span title="{{ item.last_txn_code }} - Run for Production">{{ item.last_txn_date }}</span>
                        {% elif item.last_txn_code == "BR" %}
                            <span title="{{ item.last_txn_code }} - Blend Produced">{{ item.last_txn_date }}</span>
                        {% elif item.last_txn_code == "PO" %}
                            <span title="{{ item.last_txn_code }} - Shipment Received">{{ item.last_txn_date }}</span>
                        {% else %}
                            <b>{{ item.last_txn_code }}</b>
                        {% endif %}
                    </td>
                    <td>{{ item.starttime|floatformat:2 }}</td>
                    <td>{{ item.prodline }}</td>
                    <td>
                        <div class="dropdown rtCell  dropdown-menu-end">
                            {{ item.three_wk_short|floatformat:2 }} gal
                            <button class="btn dropdown-toggle" type="button" id="shortageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="shortageDropdown">
                                <li class="dropdownLi">1Wk: {{ item.one_wk_short|floatformat:2 }}</li>
                                <li class="dropdownLi">2Wks: {{ item.two_wk_short|floatformat:2 }}</li>
                                <li class="dropdownLi">3Wks: {{ item.three_wk_short|floatformat:2 }}</li>
                            </ul>
                        </div>
                    </td>

                    <td class="text-center lotNumCell">
                        <button class="btn btn-secondary lotNumButton" data-bs-toggle="modal" data-bs-target="#addLotNumModal" data-itemcode="{{ item.component_item_code }}" data-desc="{{ item.component_item_description }}" data-threewkqty="{{ item.three_wk_short }}">+</button>
                    </td>
                    
                    <td class="text-center">
                        {% if item.schedule_value == "Not Scheduled" %}
                            Not Scheduled
                        {% else %}
                            <a href="/core/blendschedule/{{ item.schedule_value }}">{{ item.schedule_value }}</td>
                        {% endif %}
                </tr>
            {% endfor %}
        </table>
    {% else %}
        <div style="background-color: rgb(255, 142, 142);">
            <h1 class="text-center">Foam Factor Table is not populated.</h1>
            </br>
            <h1 class="text-center">Restore this table in order to view blend shortages.</h1>
        </div>
    {% endif %}

{% endblock content %}

{% block belowdeckscripts %}
    <script src="{% static 'core/js/blendShortages.js' %}"></script>
{% endblock %}